---
import Layout from "../layouts/Layout.astro";
// No getStaticPaths needed
---

<Layout title="Subscription Console">
    <header class="header-nav">
        <div class="logo">
            <a href="/studio/" class="back-link">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Dashboard
            </a>
            <span class="sep">/</span>
            <span id="db-breadcrumb" class="db-name">Loading...</span>
        </div>

        <div class="global-config">
            <div class="config-group">
                <label for="global-channel">Channel</label>
                <input
                    type="text"
                    id="global-channel"
                    placeholder="e.g. events"
                />
            </div>
            <div class="config-group">
                <label for="global-sub-name">Subscription Name</label>
                <input
                    type="text"
                    id="global-sub-name"
                    placeholder="e.g. user-1"
                />
            </div>
            <button id="subscribe-toggle-btn" class="btn btn-primary"
                >Subscribe</button
            >
        </div>

        <div class="header-actions">
            <button id="clear-messages-btn" class="btn btn-ghost"
                >Clear Messages</button
            >
        </div>
    </header>

    <main class="console-container">
        <!-- Left Pane: Payload Cards -->
        <div class="pane action-pane">
            <div class="pane-header">
                <h2>Payload Cards</h2>
                <button id="add-card-btn" class="btn btn-sm btn-secondary">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="14"
                        height="14"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><line x1="12" y1="5" x2="12" y2="19"></line><line
                            x1="5"
                            y1="12"
                            x2="19"
                            y2="12"></line></svg
                    >
                    Add Card
                </button>
            </div>
            <div id="card-container" class="notebook-container">
                <!-- Cards rendered by SubscriptionManager -->
            </div>
        </div>

        <!-- Resizer -->
        <div class="resizer" id="resizer"></div>

        <!-- Right Pane: Messages -->
        <div class="pane message-pane">
            <div class="pane-header">
                <div class="pane-title-group">
                    <h2>Messages</h2>
                    <span
                        id="message-count"
                        class="badge success"
                        style="display:none">0</span
                    >
                </div>
                <div id="sub-status" class="status-indicator">
                    <span class="dot"></span>
                    <span class="status-text">Disconnected</span>
                </div>
            </div>
            <div id="message-container" class="message-results">
                <div class="empty-state">No messages received yet.</div>
            </div>
        </div>
    </main>
</Layout>

<script>
    import { SubscriptionManager } from "../lib/subscription_manager";

    const urlParams = new URLSearchParams(window.location.search);
    const dbName = urlParams.get("db");

    if (!dbName) {
        window.location.href = "/studio/";
    } else {
        const breadcrumb = document.getElementById("db-breadcrumb");
        if (breadcrumb) breadcrumb.textContent = dbName;

        const cardContainer = document.getElementById("card-container")!;
        const messageContainer = document.getElementById("message-container")!;
        const manager = new SubscriptionManager(
            dbName,
            cardContainer,
            messageContainer,
        );

        // Global Elements
        const channelInput = document.getElementById(
            "global-channel",
        ) as HTMLInputElement;
        const subNameInput = document.getElementById(
            "global-sub-name",
        ) as HTMLInputElement;
        const subToggleBtn = document.getElementById(
            "subscribe-toggle-btn",
        ) as HTMLButtonElement;
        const clearBtn = document.getElementById(
            "clear-messages-btn",
        ) as HTMLButtonElement;
        const addCardBtn = document.getElementById(
            "add-card-btn",
        ) as HTMLButtonElement;
        const subStatus = document.getElementById("sub-status")!;

        // Initial values (wait for manager to load from storage)
        setTimeout(() => {
            channelInput.value = manager.getChannel();
            subNameInput.value = manager.getSubscriptionName();
        }, 100);

        // Config updates
        const updateConfig = () => {
            manager.updateConfig(channelInput.value, subNameInput.value);
        };
        channelInput.addEventListener("input", updateConfig);
        subNameInput.addEventListener("input", updateConfig);

        // Subscribe Toggle
        subToggleBtn.addEventListener("click", () => {
            manager.toggleSubscription((msg) => {
                console.log("New message received:", msg);
                updateMessageCount();
            });
            updateUI();
        });

        // Clear Messages
        clearBtn.addEventListener("click", () => {
            manager.clearMessages();
            updateMessageCount();
        });

        function updateMessageCount() {
            const countEl = document.getElementById("message-count")!;
            const count = manager.getMessages().length;
            if (count > 0) {
                countEl.textContent = count.toString();
                countEl.style.display = "inline-block";
            } else {
                countEl.style.display = "none";
            }
        }

        // Initial count
        setTimeout(updateMessageCount, 200);

        // Add Card
        addCardBtn.addEventListener("click", () => {
            manager.addCard();
        });

        function updateUI() {
            const active = manager.getSubscriptionStatus();
            subToggleBtn.textContent = active ? "Unsubscribe" : "Subscribe";
            subToggleBtn.className = active
                ? "btn btn-danger"
                : "btn btn-primary";
            subStatus.className = active
                ? "status-indicator active"
                : "status-indicator";
            subStatus.querySelector(".status-text")!.textContent = active
                ? "Connected"
                : "Disconnected";

            // Disable inputs while subscribed
            channelInput.disabled = active;
            subNameInput.disabled = active;
        }

        // --- Resizer Logic ---
        const resizer = document.getElementById("resizer")!;

        // Load saved width
        const savedWidth = localStorage.getItem("studio-pane-width");
        if (savedWidth) {
            document.documentElement.style.setProperty(
                "--left-pane-width",
                `${savedWidth}px`,
            );
        }

        let isResizing = false;

        resizer.addEventListener("mousedown", (_e) => {
            isResizing = true;
            document.body.style.cursor = "col-resize";
            resizer.classList.add("active");
        });

        document.addEventListener("mousemove", (e) => {
            if (!isResizing) return;
            e.preventDefault();
            const newWidth = e.clientX;
            // Min/Max constraints
            if (newWidth > 200 && newWidth < window.innerWidth - 300) {
                document.documentElement.style.setProperty(
                    "--left-pane-width",
                    `${newWidth}px`,
                );
            }
        });

        document.addEventListener("mouseup", (_e) => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = "default";
                resizer.classList.remove("active");
                // Save width
                const currentWidth = getComputedStyle(
                    document.documentElement,
                ).getPropertyValue("--left-pane-width");
                localStorage.setItem(
                    "studio-pane-width",
                    parseFloat(currentWidth).toString(),
                );
            }
        });
    }
</script>

<style>
    .header-nav {
        display: flex;
        align-items: center;
        padding: 0.75rem 1.5rem;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        gap: 2rem;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
        white-space: nowrap;
    }

    .back-link {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.9rem;
        transition: color 0.15s;
    }

    .back-link:hover {
        color: var(--accent-color);
    }

    .sep {
        color: var(--border-color);
        font-weight: 300;
    }

    .db-name {
        color: var(--text-primary);
        font-weight: 600;
    }

    .global-config {
        display: flex;
        align-items: flex-end;
        gap: 1rem;
        flex: 1;
    }

    .config-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .config-group label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.02em;
    }

    .config-group input {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 0.4rem 0.75rem;
        color: var(--text-primary);
        font-size: 0.9rem;
        min-width: 180px;
    }

    .config-group input:focus {
        border-color: var(--accent-color);
        outline: none;
    }

    .config-group input:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .header-actions {
        display: flex;
        gap: 0.75rem;
    }

    :root {
        --left-pane-width: 40%;
    }

    .console-container {
        display: grid;
        grid-template-columns: var(--left-pane-width) 4px 1fr;
        height: calc(100vh - 61px);
        overflow: hidden;
        background: var(--bg-primary);
    }

    .pane {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
    }

    .action-pane {
        background: var(--bg-secondary);
        border-right: none;
    }

    .message-pane {
        background: var(--bg-primary);
        overflow: auto;
    }

    .pane-header {
        height: 52px; /* Explicit height for consistency */
        padding: 0 1rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-primary);
    }

    .pane-header h2 {
        font-size: 0.95rem; /* Standardized size */
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        text-transform: none;
        letter-spacing: normal;
    }

    .pane-title-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .notebook-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    /* Result Styling matching console.astro */
    :global(.result-header) {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-secondary);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 5;
    }

    :global(.result-body) {
        padding: 0;
    }

    :global(.table-wrapper) {
        width: 100%;
    }

    :global(table) {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        font-family: var(--mono-font);
    }

    :global(th) {
        text-align: left;
        border-bottom: 2px solid var(--border-color);
        padding: 0.75rem 1rem;
        white-space: nowrap;
        background: var(--bg-secondary);
        position: sticky;
        top: 0;
        color: var(--text-primary);
        font-size: 0.85rem;
        text-transform: none;
    }

    :global(td) {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border-color);
        vertical-align: top;
        color: var(--text-primary);
        overflow: hidden;
        text-overflow: ellipsis;
    }

    :global(.id-cell) {
        width: 80px;
        color: var(--text-secondary);
        font-size: 0.8rem;
    }

    :global(.time-cell) {
        width: 150px;
        color: var(--text-secondary);
        font-size: 0.8rem;
        text-align: right;
    }

    :global(.payload-cell-container) {
        width: auto;
        white-space: normal;
    }

    :global(tr:hover td) {
        background: var(--bg-secondary);
    }

    :global(.payload-cell) {
        margin: 0;
        font-family: var(--mono-font);
        white-space: pre-wrap;
        color: var(--accent-color);
        flex: 1;
    }

    :global(.payload-wrapper) {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        position: relative;
    }

    :global(.copy-payload-btn) {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        padding: 4px;
        border-radius: 4px;
        opacity: 0;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        margin-top: -2px;
    }

    :global(tr:hover .copy-payload-btn) {
        opacity: 1;
    }

    :global(.copy-payload-btn:hover) {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    /* Indicators */
    .status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    .status-indicator .dot {
        width: 8px;
        height: 8px;
        background: #64748b;
        border-radius: 50%;
    }

    .status-indicator.active .dot {
        background: var(--success-color);
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
    }

    .status-indicator.active .status-text {
        color: var(--success-color);
    }

    /* Resizer */
    .resizer {
        width: 4px;
        background: var(--border-color); /* Match console.astro */
        cursor: col-resize;
        transition: background 0.2s;
        z-index: 10;
    }

    .resizer:hover,
    .resizer.active {
        background: var(--accent-color);
        width: 6px;
        margin-left: -1px;
    }

    /* UI Components */
    :global(.notebook-card) {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: border-color 0.2s;
    }

    :global(.notebook-card:hover) {
        border-color: var(--accent-color);
    }

    :global(.card-header-row) {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    :global(.payload-editor) {
        width: 100%;
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 0.75rem;
        font-family: var(--mono-font);
        resize: vertical;
        font-size: 0.9rem;
    }

    :global(.card-actions) {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 1rem;
    }

    :global(.error-text) {
        color: var(--danger-color);
        font-size: 0.8rem;
    }

    .btn-secondary {
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
        background-color: var(--border-color);
    }

    .btn-danger {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid transparent;
    }

    .btn-danger:hover {
        background: #ef4444;
        color: white;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }

    .btn-ghost {
        background-color: transparent;
        color: var(--text-secondary);
        border: 1px solid transparent;
    }

    .btn-ghost:hover {
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
    }

    :global(.badge) {
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 4px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-weight: normal;
        text-transform: none;
    }

    :global(.badge.success) {
        color: var(--success-color);
        background: rgba(16, 185, 129, 0.1);
    }

    :global(.empty-state) {
        color: var(--text-secondary);
        padding: 2rem;
        text-align: center;
        font-style: italic;
    }
</style>
